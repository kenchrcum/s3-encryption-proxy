# Milestone v0.5 â€” Issue Tracker and Implementation Guide

This document tracks all issues for v0.5 with implementation guides, tests, and acceptance criteria derived from `docs/ROADMAP.md`.

## Scope and Goals
- External KMS integrations (AWS KMS, Vault Transit) with envelope encryption, key versioning, rotation policy
- S3 compatibility (presigned URL compatibility; tagging passthrough refinements)
- Performance (parallel chunk crypto; AES-NI/ARM detection feature flags)
- Observability (metrics cardinality controls; audit log sink integrations)
- Operations & Helm/K8s (hardened securityContext; NetworkPolicy examples)
- Config & UX (per-bucket/tenant policy files)
- Testing & Quality (chaos tests; fuzzers)
- Docs (threat model and hardening guide)

## Milestone Acceptance Criteria
- KMS Integration: Successful encrypt/decrypt with external KMS, seamless rotation with dual-read window, audited events.
- Observability: Metrics cardinality bounded under load; audit logs stream to chosen sink.

Labels: `milestone:v0.5`, `area:kms`, `area:s3`, `area:perf`, `area:observability`, `area:helm`, `security`.

---

## [V0.5-KMS-1] External KMS Integrations
- Owner: Crypto
- Priority: P0

### Summary
Add integrations for AWS KMS and HashiCorp Vault Transit using envelope encryption and key version tracking in metadata.

### Affected
- `internal/crypto/keymanager.go`
- `internal/crypto/engine.go`
- `internal/config/config.go`
- `docs/KMS_COMPATIBILITY.md`

### Implementation Guide
- [ ] Define `KeyManager` adapter interface (versioned keys, encrypt/decrypt small DEKs, cache behavior).
- [ ] Implement AWS KMS adapter (SDK v2), Vault Transit adapter; include health checks.
- [ ] Envelope: generate DEK locally, wrap with KMS, store ciphertext + `keyVersion` in metadata.
- [ ] Add dual-read window for rotation (try current key then previous N versions).
- [ ] Config: endpoints, auth, timeouts, retries, cache TTLs.

### Security Considerations
- Do not log key material; constant-time compare; zeroize DEKs after use.

### Tests
- Unit: mock KMS clients; failure modes; rotation paths
- Integration: local Vault dev server; AWS KMS stub/mocked

### Definition of Done
- [ ] Encrypt/decrypt successful via both KMS backends
- [ ] Rotation policy implemented with configurable grace window

---

## [V0.5-KMS-2] Rotation Policy & Tooling
- Owner: Crypto
- Priority: P1

### Summary
Implement rotation policy and operational tooling/docs.

### Implementation Guide
- [ ] Configurable rotation schedule; audit events emitted.
- [ ] Dual-read window documented; metrics for rotated reads.
- [ ] Admin runbook in docs.

### Definition of Done
- [ ] Rotation demo scenario reproducible in CI/manual

---

## [V0.5-S3-1] Presigned URL Compatibility
- Owner: API
- Priority: P1

### Summary
Ensure presigned URL flows operate through the gateway with correct canonical request and header handling.

### Affected
- `internal/api/handlers.go`
- `internal/middleware/security.go`
- `docs/S3_API_IMPLEMENTATION.md`

### Implementation Guide
- [ ] Preserve/forward required headers; avoid mutation of signed components.
- [ ] Document compatibility caveats; add tests for common SDKs.

### Tests
- Integration: AWS SDKs presign GET/PUT; curl invocation

### Definition of Done
- [ ] Presigned URLs function across providers and SDKs

---

## [V0.5-S3-2] Tagging and Metadata Passthrough
- Owner: API
- Priority: P2

### Summary
Refine object tagging and metadata passthrough.

### Implementation Guide
- [ ] Validate size/charset limits; preserve user tags; encrypt-only internal metadata.

### Definition of Done
- [ ] Tagging round-trips in integration tests

---

## [V0.5-PERF-1] Parallel Chunk Crypto Pipeline
- Owner: Perf/Crypto
- Priority: P1

### Summary
Introduce bounded-concurrency pipeline for encryption/decryption of chunks.

### Affected
- `internal/crypto/encrypt_reader.go`
- `internal/crypto/decrypt_reader.go`

### Implementation Guide
- [ ] Add worker pool with backpressure; maintain order in output stream.
- [ ] Tune chunk sizes; benchmark throughput vs CPU.

### Tests
- Benchmarks; race tests

### Definition of Done
- [ ] Throughput improved without violating streaming semantics

---

## [V0.5-PERF-2] AES-NI/ARM Feature Flags
- Owner: Perf
- Priority: P2

### Summary
Detect hardware acceleration and expose feature flags.

### Affected
- `internal/crypto/hardware.go`
- `internal/config/config.go`

### Implementation Guide
- [ ] Detect capabilities; report metrics; optional disable flags.

### Definition of Done
- [ ] Flags controllable; metrics observed

---

## [V0.5-OBS-1] Metrics Cardinality Controls
- Owner: Observability
- Priority: P1

### Summary
Bound metrics cardinality; add exemplars for traces.

### Affected
- `internal/metrics/*`

### Implementation Guide
- [ ] Label allowlist/aggregation; sampling exemplars.

### Definition of Done
- [ ] No unbounded labels; exemplars linked to traces

---

## [V0.5-OBS-2] Audit Log Sink Integrations
- Owner: Observability/SecOps
- Priority: P2

### Summary
Integrate with Loki/ELK/OpenSearch for structured audit logs.

### Implementation Guide
- [ ] Add sinks and batching; backoff/retry; redaction.

### Definition of Done
- [ ] Events reliably delivered under load

---

## [V0.5-OPS-1] Hardened securityContext & NetworkPolicies
- Owner: Helm
- Priority: P1

### Summary
Provide hardened defaults and example NetworkPolicies.

### Affected
- `helm/s3-encryption-gateway/templates/*`
- `helm/s3-encryption-gateway/values.yaml`

### Implementation Guide
- [ ] ReadOnlyRootFilesystem, seccomp, runAsNonRoot defaults.
- [ ] Egress/ingress examples for common topologies.

### Definition of Done
- [ ] Lint passes; examples validated

---

## [V0.5-CFG-1] Per-bucket/Tenant Policy Files
- Owner: Config
- Priority: P1

### Summary
Allow per-bucket/tenant settings (keys, compression, limits) via policy files.

### Implementation Guide
- [ ] Policy format; loader; validation; precedence rules.

### Definition of Done
- [ ] Policies applied correctly; documented

---

## [V0.5-QA-1] Chaos Tests
- Owner: QA
- Priority: P2

### Summary
Add tests for backend throttling/500s and network partitions.

### Definition of Done
- [ ] Resilience verified; graceful degradation

---

## [V0.5-QA-2] Fuzzers for Metadata/Range
- Owner: QA
- Priority: P2

### Summary
Fuzzers for metadata parsing and range math.

### Definition of Done
- [ ] No panics; test corpus added

---

## [V0.5-QA-3] E2E Provider Matrix
- Owner: QA
- Priority: P1

### Summary
Run E2E tests against AWS S3, MinIO, Wasabi, Hetzner.

### Implementation Guide
- [ ] Parameterize providers and credentials in `test/docker-compose.yml` or CI.
- [ ] Validate put/get/list/multipart with encryption on/off.

### Definition of Done
- [ ] All providers green for core flows

---

## [V0.5-DOC-1] Threat Model and Hardening Guide
- Owner: Docs/Sec
- Priority: P2

### Summary
Publish STRIDE-based threat model and mitigations; security hardening guide.

### Definition of Done
- [ ] Document lives in `docs/SECURITY_AUDIT.md` and linked

---

## Tracking Checklist (Milestone Level)
- [ ] All P0/P1 closed
- [ ] KMS integration demo recorded
- [ ] Docs and examples updated
