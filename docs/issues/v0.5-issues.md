# Milestone v0.5 — Issue Tracker and Implementation Guide

This document tracks all issues for v0.5 with implementation guides, tests, and acceptance criteria derived from `docs/ROADMAP.md`.

## Scope and Goals
- External KMS integrations (AWS KMS, Vault Transit) with envelope encryption, key versioning, rotation policy
- S3 compatibility (presigned URL compatibility; tagging passthrough refinements)
- Performance (parallel chunk crypto; AES-NI/ARM detection feature flags)
- Observability (metrics cardinality controls; audit log sink integrations)
- Operations & Helm/K8s (hardened securityContext; NetworkPolicy examples)
- Config & UX (per-bucket/tenant policy files)
- Testing & Quality (chaos tests; fuzzers)
- Docs (threat model and hardening guide)

## Milestone Acceptance Criteria
- KMS Integration: Successful encrypt/decrypt with external KMS, seamless rotation with dual-read window, audited events.
- Observability: Metrics cardinality bounded under load; audit logs stream to chosen sink.

Labels: `milestone:v0.5`, `area:kms`, `area:s3`, `area:perf`, `area:observability`, `area:helm`, `security`.

---

## [V0.5-KMS-1] External KMS Integrations
- Owner: Crypto
- Priority: P0
- Status: ✅ **COMPLETE** (Cosmian KMIP only)

### Summary
Add integrations for external KMS using envelope encryption and key version tracking in metadata. **Note**: Only Cosmian KMIP is implemented in v0.5. AWS KMS and Vault Transit are deferred to v1.0 due to licensing/testing constraints (see decision document).

### Affected
- `internal/crypto/keymanager.go`
- `internal/crypto/engine.go`
- `internal/config/config.go`
- `docs/KMS_COMPATIBILITY.md`

### Implementation Guide
- [x] Define `KeyManager` adapter interface (versioned keys, encrypt/decrypt small DEKs, cache behavior).
- [x] Implement Cosmian KMIP adapter with envelope encryption support.
- [x] Envelope: generate DEK locally, wrap with KMS, store ciphertext + `keyVersion` in metadata.
- [x] Add dual-read window for rotation (try current key then previous N versions).
- [x] Config: endpoints, auth, timeouts, retries for Cosmian.
- [x] Health checks for Cosmian KMIP (integrated into readiness endpoint).
- [ ] ~~Implement AWS KMS adapter (SDK v2)~~ → Deferred to v1.0 (see V1.0-KMS-2)
- [ ] ~~Implement Vault Transit adapter~~ → Deferred to v1.0 (see V1.0-KMS-3)

### Security Considerations
- Do not log key material; constant-time compare; zeroize DEKs after use.

### Tests
- [x] Unit: mock KMS clients; failure modes; rotation paths
- [x] Integration: Cosmian KMIP server with Docker-based testing

### Definition of Done
- [x] Encrypt/decrypt successful via Cosmian KMIP backend
- [x] Rotation policy implemented with configurable grace window
- [x] KeyManager interface defined and documented
- [x] Envelope encryption flow implemented and tested
- [x] Health checks implemented and integrated into readiness endpoint

---

## [V0.5-KMS-2] Rotation Policy & Tooling
- Owner: Crypto
- Priority: P1
- Status: ✅ **COMPLETE**

### Summary
Implement rotation policy and operational tooling/docs.

### Affected
- `internal/config/config.go` - Added `RotationPolicyConfig` with grace window
- `internal/metrics/metrics.go` - Added `kms_rotated_reads_total` metric
- `internal/api/handlers.go` - Track rotated reads and emit audit events
- `docs/KMS_COMPATIBILITY.md` - Documented dual-read window and rotation policy
- `docs/KEY_ROTATION_RUNBOOK.md` - Admin runbook for rotation procedures
- `test/rotation_test.sh` - Test script for rotation scenario

### Implementation Guide
- [x] Configurable rotation schedule; audit events emitted.
- [x] Dual-read window documented; metrics for rotated reads.
- [x] Admin runbook in docs.

### Implementation Details
- **Rotation Policy Configuration**: Added `RotationPolicyConfig` with `enabled` flag and `grace_window` duration
- **Metrics**: Added `kms_rotated_reads_total` counter with labels `key_version` and `active_version`
- **Audit Logging**: Decrypt events include `rotated_read` metadata when non-active keys are used
- **Handler Integration**: Tracks rotated reads by comparing key version from metadata with active version
- **Documentation**: Comprehensive guide on dual-read window, rotation workflow, and monitoring
- **Runbook**: Step-by-step procedures for rotation, monitoring, and troubleshooting
- **Demo Script**: Reproducible demo scenario showing rotation workflow

### Definition of Done
- [x] Rotation demo scenario reproducible in CI/manual

---

## [V0.5-S3-1] Presigned URL Compatibility
- Owner: API
- Priority: P1
- Status: ✅ **COMPLETE**

### Summary
Ensure presigned URL flows operate through the gateway with correct canonical request and header handling.

### Affected
- `internal/api/handlers.go`
- `internal/middleware/security.go`
- `docs/S3_API_IMPLEMENTATION.md`

### Implementation Guide
- [x] Preserve/forward required headers; avoid mutation of signed components.
- [x] Document compatibility caveats; add tests for common SDKs.

### Tests
- [x] Integration: AWS SDKs presign GET/PUT; curl invocation

### Definition of Done
- [x] Presigned URLs function across providers and SDKs

---

## [V0.5-S3-2] Tagging and Metadata Passthrough
- Owner: API
- Priority: P2
- Status: ✅ **COMPLETE**

### Summary
Refine object tagging and metadata passthrough.

### Implementation Guide
- [x] Validate size/charset limits; preserve user tags; encrypt-only internal metadata.

### Definition of Done
- [x] Tagging round-trips in integration tests

---

## [V0.5-PERF-1] Parallel Chunk Crypto Pipeline
- Owner: Perf/Crypto
- Priority: P1
- Status: ✅ **COMPLETE**

### Summary
Introduce bounded-concurrency pipeline for encryption/decryption of chunks.

### Affected
- `internal/crypto/encrypt_reader.go`
- `internal/crypto/decrypt_reader.go`

### Implementation Guide
- [x] Add worker pool with backpressure; maintain order in output stream.
- [x] Tune chunk sizes; benchmark throughput vs CPU.

### Tests
- Benchmarks; race tests

### Definition of Done
- [x] Throughput improved without violating streaming semantics

---

## [V0.5-PERF-2] AES-NI/ARM Feature Flags
- Owner: Perf
- Priority: P2
- Status: ✅ **COMPLETE**

### Summary
Detect hardware acceleration and expose feature flags.

### Affected
- `internal/crypto/hardware.go`
- `internal/config/config.go`

### Implementation Guide
- [x] Detect capabilities; report metrics; optional disable flags.

### Definition of Done
- [x] Flags controllable; metrics observed

---

## [V0.5-OBS-1] Metrics Cardinality Controls
- Owner: Observability
- Priority: P1
- Status: ✅ **COMPLETE**

### Summary
Bound metrics cardinality; add exemplars for traces.

### Affected
- `internal/metrics/*`

### Implementation Guide
- [x] Label allowlist/aggregation; sampling exemplars.

### Definition of Done
- [x] No unbounded labels; exemplars linked to traces

---

## [V0.5-OBS-2] Audit Log Sink Integrations
- Owner: Observability/SecOps
- Priority: P2
- Status: ✅ **COMPLETE**

### Summary
Integrate with Loki/ELK/OpenSearch for structured audit logs.

### Implementation Guide
- [x] Add sinks and batching; backoff/retry; redaction.

### Definition of Done
- [x] Events reliably delivered under load

---

## [V0.5-OPS-1] Hardened securityContext & NetworkPolicies
- Owner: Helm
- Priority: P1
- Status: ✅ **COMPLETE**

### Summary
Provide hardened defaults and example NetworkPolicies.

### Affected
- `helm/s3-encryption-gateway/templates/*`
- `helm/s3-encryption-gateway/values.yaml`

### Implementation Guide
- [x] ReadOnlyRootFilesystem, seccomp, runAsNonRoot defaults.
- [x] Egress/ingress examples for common topologies.

### Implementation Details
- **Security Context**: Added `seccompProfile: {type: RuntimeDefault}` to container security context (pod security context already had `runAsNonRoot`, `readOnlyRootFilesystem`, and capability dropping)
- **Network Policy Enhancements**:
  - Added DNS egress rules (UDP/TCP port 53)
  - Added configurable AWS S3 egress rules with specific CIDR blocks
  - Added MinIO internal cluster communication egress rules
  - Added monitoring/logging service egress rules
  - Added ingress controller and monitoring service ingress rules
  - All rules are configurable via values.yaml

### Definition of Done
- [x] Lint passes; examples validated

---

## [V0.5-CFG-1] Per-bucket/Tenant Policy Files
- Owner: Config
- Priority: P1
- Status: ✅ **COMPLETE**

### Summary
Allow per-bucket/tenant settings (keys, compression, limits) via policy files.

### Implementation Guide
- [x] Policy format; loader; validation; precedence rules.

### Definition of Done
- [x] Policies applied correctly; documented

---

## [V0.5-QA-1] Chaos Tests
- Owner: QA
- Priority: P2
- Status: ✅ **COMPLETE**

### Summary
Add tests for backend throttling/500s and network partitions.

### Definition of Done
- [x] Resilience verified; graceful degradation

---

## [V0.5-QA-2] Fuzzers for Metadata/Range
- Owner: QA
- Priority: P2
- Status: ✅ **COMPLETE**

### Summary
Fuzzers for metadata parsing and range math.

### Definition of Done
- [x] No panics; test corpus added

---

## [V0.5-QA-3] E2E Provider Matrix
- Owner: QA
- Priority: P1
- Status: ✅ **COMPLETE**

### Summary
Run E2E tests against AWS S3, MinIO, Wasabi, Hetzner.

### Implementation Guide
- [x] Parameterize providers and credentials in `test/docker-compose.yml` or CI.
- [x] Validate put/get/list/multipart with encryption on/off.

### Definition of Done
- [x] All providers green for core flows

---

## [V0.5-DOC-1] Threat Model and Hardening Guide
- Owner: Docs/Sec
- Priority: P2

### Summary
Publish STRIDE-based threat model and mitigations; security hardening guide.

### Definition of Done
- [x] Document lives in `docs/SECURITY_AUDIT.md` and linked

---

## Tracking Checklist (Milestone Level)
- [ ] All P0/P1 closed
- [ ] KMS integration demo recorded
- [ ] Docs and examples updated
