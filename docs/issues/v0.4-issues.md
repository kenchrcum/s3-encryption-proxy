# Milestone v0.4 â€” Issue Tracker and Implementation Guide

This document tracks all issues for v0.4 and provides concise implementation guides, test plans, and acceptance criteria derived from `docs/ROADMAP.md`.

## Scope and Goals
- Security/Crypto hardening for range-optimized decryption and metadata compaction policy
- S3 compatibility improvements (List ops parity, multipart stability)
- Performance (buffer pooling; backpressure/streaming tuning)
- Observability (OpenTelemetry tracing; access log presets)
- Operations & Helm/K8s (Ingress, PDB, topologySpreadConstraints, PodMonitor, extra knobs)
- Config & UX (hot-reload, config schema docs)
- Testing & Quality (E2E provider matrix; load/regression suite)
- Docs (exported diagrams and ADRs)

## Milestone Acceptance Criteria
- Range Optimization: 100% pass on table-driven tests for edge ranges; <5% error in time-to-first-byte vs plaintext baseline for chunked.
- Helm/K8s: Install with Ingress/PDB/topologySpreadConstraints; NetworkPolicy examples; lint passes; values schema present.
- Observability: OTEL traces visible in chosen backend; metrics cardinality bounded under load.

Labels: `milestone:v0.4`, `area:crypto`, `area:s3`, `area:perf`, `area:helm`, `area:observability`, `good-first-test`, `needs-design`.

---

## [V0.4-SEC-1] Range-Optimized Decryption Hardening
- Owner: Crypto
- Priority: P0

### Summary
Harden range-aware decryption: correctness of `Content-Range`, partial reads across chunk boundaries, and accurate size/ETag reporting for ranged and full responses.

### Affected
- `internal/crypto/range_optimization.go`
- `internal/crypto/range_decrypt.go`
- `internal/crypto/chunked.go`
- `internal/api/handlers.go` (range header mapping)

### Implementation Guide
- [x] Add table-driven tests covering: first-byte, last-byte, suffix ranges, cross-chunk boundaries, empty ranges, out-of-bounds clamping.
- [x] Ensure decrypter aligns and decrypts only required chunks; verify authentication tags for touched chunks.
- [x] Validate `Content-Range`/`Content-Length` mapping from plaintext range to encrypted object sizes.
- [x] Guarantee deterministic ETag behavior/translation; document behavior where passthrough isn't possible.
- [x] Optimize to minimize extra chunk reads; document worst-case overhead.

### Tests
- Unit: `internal/crypto/range_optimization_test.go`, `range_decrypt_test.go`, `chunked_test.go`
- Integration: `test/integration_test.go` with ranged GETs against MinIO
- Fuzz: Fuzz ranges and chunk sizes

### Definition of Done
- [x] All table tests pass; no regressions in `engine_test.go`
- [x] Time-to-first-byte regression <5% vs plaintext baseline for typical ranges
- [x] Docs updated in `docs/ENCRYPTION_DESIGN.md` (range math appendix)

---

## [V0.4-SEC-2] Metadata Compaction Policy
- Owner: Crypto
- Priority: P1

### Summary
Ensure encryption/compression metadata fits within provider header limits; add provider profiles (AWS, MinIO, Wasabi, Hetzner).

### Affected
- `internal/crypto/engine.go`
- `internal/crypto/compression.go`
- `internal/s3/client.go`
- `docs/S3_API_IMPLEMENTATION.md`

### Implementation Guide
- [x] Define provider header limits and reserved budget (per RFCs and provider docs).
- [x] Compact metadata keys/values (short keys, base64url, omit defaults).
- [x] Add provider profiles and selection via config; warn on nearing limits.
- [x] Fallback to object metadata storage strategy if headers would overflow (documented).

### Tests
- Unit: serialization size tests; compaction on/off
- Integration: upload with maximum realistic metadata; verify success across providers

### Definition of Done
- [x] Profiles for AWS/MinIO/Wasabi/Hetzner documented and enforced
- [x] No header overflow in integration suite

---

## [V0.4-S3-1] List Operations Parity
- Owner: API
- Priority: P1

### Summary
Expand List operations parity: `delimiter`, continuation tokens, and prefixes to match S3 behavior.

### Affected
- `internal/api/handlers.go`
- `internal/s3/client.go`
- `docs/S3_API_IMPLEMENTATION.md`

### Implementation Guide
- [x] Add conformance tests for delimiter/prefix/common prefixes.
- [x] Support continuation tokens; ensure stable ordering.
- [x] Translate gateway metadata correctly in listings.

### Tests
- Unit: handler utils for token/marker encode-decode
- Integration: compare against AWS S3/MinIO behavior

### Definition of Done
- [x] Parity tests pass against at least two providers

---

## [V0.4-S3-2] Multipart Stability & Interop
- Owner: API
- Priority: P0

### Summary
Fuzz XML parser for `CompleteMultipartUpload` and add tests for interop with AWS/MinIO multipart flows.

### Affected
- `internal/api/handlers.go`
- `internal/s3/client.go`
- `docs/S3_API_IMPLEMENTATION.md`

### Implementation Guide
- [x] Add robust XML decoding with limits and clear error translation.
- [x] Fuzz inputs for part ordering, duplicates, invalid ETags.
- [x] Interop tests: initiate, upload, complete, abort flows across providers.

### Tests
- Fuzz: XML payloads
- Integration: multipart lifecycle across providers

### Definition of Done
- [x] No panics; correct error mapping; interop green

---

## [V0.4-PERF-1] Buffer Pooling for Small IO
- Owner: Crypto/Perf
- Priority: P1

### Summary
Introduce pooling for small reads/writes to reduce allocations.

### Affected
- `internal/crypto/encrypt_reader.go`
- `internal/crypto/decrypt_reader.go`
- `internal/crypto/engine.go`

### Implementation Guide
- [x] Add sized buffer pools (e.g., sync.Pool with buckets).
- [x] Integrate in hot paths; ensure zeroization on reuse when holding sensitive data.
- [x] Metrics to gauge hit/miss rates.

### Tests
- Benchmarks in `engine_bench_test.go`
- Race tests to ensure safety

### Definition of Done
- [x] Allocation rate drops in benchmarks without regressions

---

## [V0.4-PERF-2] Backpressure & Streaming Tuning
- Owner: Perf
- Priority: P2

### Summary
Tune streaming paths and backpressure for large objects.

### Affected
- `internal/crypto/*`
- `internal/s3/proxy_client.go`

### Implementation Guide
- [x] Review readers/writers for bounded queues.
- [x] Add context-aware cancellation and timeouts on pipelines.
- [x] Document recommended limits in `docs/DEPLOYMENT.md`.

### Tests
- Load tests in `test/load_test.go`

### Definition of Done
- [x] Improved P95 latency and stable memory under load

---

## [V0.4-OBS-1] OpenTelemetry Tracing
- Owner: Observability
- Priority: P1

### Summary
Add OTEL tracing for HTTP and S3 spans with optional sampling.

### Affected
- `internal/api/handlers.go`
- `internal/s3/client.go`
- `internal/middleware/logging.go`
- `internal/metrics/*`
- `internal/config/config.go`

### Implementation Guide
- [x] Add OTEL SDK wiring with exporter config.
- [x] Instrument inbound HTTP, backend S3 calls, and crypto steps as spans.
- [x] Add sampling, redaction of sensitive attributes.

### Tests
- Unit: basic tracer init and span presence
- Manual: verify spans in chosen backend

### Definition of Done
- [x] Traces visible end-to-end; cardinality bounded

---

## [V0.4-OBS-2] Access Log Presets
- Owner: Observability
- Priority: P2

### Summary
Add JSON and CLF access log presets with sensitive header redaction.

### Affected
- `internal/middleware/logging.go`
- `internal/config/config.go`

### Implementation Guide
- [x] Implement presets with structured fields.
- [x] Redact keys and auth tokens by default.

### Tests
- Unit: format correctness and redaction

### Definition of Done
- [x] Configurable presets documented in `docs/DEVELOPMENT_GUIDE.md`

---

## [V0.4-OPS-1] Helm/K8s Templates
- Owner: Helm
- Priority: P0

### Summary
Add Ingress template (optional), PodDisruptionBudget, topologySpreadConstraints, and PodMonitor alternative to ServiceMonitor.

### Affected
- `helm/s3-encryption-gateway/templates/*`
- `helm/s3-encryption-gateway/values.yaml`

### Implementation Guide
- [ ] Ingress: optional block with common annotations.
- [ ] PDB: minAvailable / maxUnavailable configurable.
- [ ] topologySpreadConstraints: optional with selectors.
- [ ] PodMonitor: optional alternative to ServiceMonitor.

### Tests
- Helm unit tests via `helm template` and `helm lint` in CI

### Definition of Done
- [ ] Lint passes; templates render with defaults and example overrides

---

## [V0.4-OPS-2] Extra Knobs in Helm Chart
- Owner: Helm
- Priority: P1

### Summary
Expose `extraEnv`, `extraVolumeMounts`, `extraVolumes`, `initContainers`, `sidecars` in values.

### Affected
- `helm/s3-encryption-gateway/values.yaml`
- `helm/s3-encryption-gateway/templates/deployment.yaml`

### Implementation Guide
- [ ] Add values and conditional rendering blocks.
- [ ] Document examples in `helm/s3-encryption-gateway/README.md`.

### Definition of Done
- [ ] Examples render and pass basic validation

---

## [V0.4-CFG-1] Hot-Reload for Non-Crypto Knobs
- Owner: Config
- Priority: P2

### Summary
Support SIGHUP/file watch to reload non-crypto settings.

### Affected
- `internal/config/config.go`
- `cmd/server/main.go`

### Implementation Guide
- [x] File watcher or SIGHUP handler to reload config.
- [x] Validate and apply only safe fields; log diffs.

### Tests
- Unit: reloader logic; invalid changes rejected
- Manual: SIGHUP reload

### Definition of Done
- [x] Safe hot-reloads without downtime

---

## [V0.4-CFG-2] Config Schema Docs
- Owner: Docs
- Priority: P2

### Summary
Add schema docs: types, units, env var mapping.

### Affected
- `docs/README.md`
- `docs/DEVELOPMENT_GUIDE.md`

### Implementation Guide
- [ ] Generate schema from structs or maintain YAML with comments.
- [ ] Map env vars; provide examples.

### Definition of Done
- [ ] Clear schema table with examples

---

## [V0.4-QA-1] E2E Provider Matrix
- Owner: QA
- Priority: P1

### Summary
Run E2E tests against AWS S3, MinIO, Wasabi, Hetzner.

### Implementation Guide
- [ ] Parameterize providers and credentials in `test/docker-compose.yml` or CI.
- [ ] Validate put/get/list/multipart with encryption on/off.

### Definition of Done
- [ ] All providers green for core flows

---

## [V0.4-QA-2] Load/Regression Suite
- Owner: QA/Perf
- Priority: P2

### Summary
Add load tests focusing on range and multipart.

### Definition of Done
- [ ] Baseline metrics recorded; regressions tracked

---

## [V0.4-DOC-1] Exported Diagrams and ADRs
- Owner: Docs
- Priority: P3

### Summary
Export SVG diagrams and add ADRs for range optimization and multipart decisions.

### Definition of Done
- [ ] Diagrams in `docs/`; ADRs committed and linked

---

## Tracking Checklist (Milestone Level)
- [ ] All P0 issues closed
- [ ] Acceptance criteria validated
- [ ] Helm chart renders with new options
- [ ] Docs updated and reviewed
