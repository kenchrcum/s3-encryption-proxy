suite: client-credentials-enabled
description: Test configuration with useClientCredentials enabled

tests:
  - it: should exclude BACKEND_ACCESS_KEY and BACKEND_SECRET_KEY when useClientCredentials is enabled
    template: templates/deployment.yaml
    set:
      config.backend.useClientCredentials.value: "true"
      config.encryption.password.value: "test-password"
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BACKEND_USE_CLIENT_CREDENTIALS
            value: "true"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: BACKEND_ACCESS_KEY
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: BACKEND_SECRET_KEY

  - it: should work with useClientCredentials enabled via valueFrom
    template: templates/deployment.yaml
    set:
      config.backend.useClientCredentials.valueFrom:
        configMapKeyRef:
          name: test-config
          key: use-client-credentials
      config.encryption.password.value: "test-password"
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BACKEND_USE_CLIENT_CREDENTIALS
            valueFrom:
              configMapKeyRef:
                name: test-config
                key: use-client-credentials
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: BACKEND_ACCESS_KEY
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: BACKEND_SECRET_KEY

